<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pat the Alien | Class Analytics</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <style>
    :root {
      --primary: #3498db;
      --bg: #f4f7f6;
      --card: #ffffff;
      --text: #2c3e50;
      --danger: #e74c3c;
    }

    body { 
      font-family: 'Inter', 'Segoe UI', sans-serif; 
      background-color: var(--bg); 
      color: var(--text);
      margin: 0;
      padding: 20px;
    }

    h1 { text-align: center; font-size: 2.2em; margin-bottom: 5px; color: #1a252f; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 25px; }
    
    /* Control Panel */
    .control-panel { 
      max-width: 1100px; 
      margin: 0 auto 20px auto; 
      display: flex; 
      justify-content: center; 
      gap: 15px; 
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    .btn-download { background-color: #2c3e50; color: white; }
    .btn-clear { background-color: #fff; color: var(--danger); border: 1px solid var(--danger); }

    /* Stats Card */
    .stat-circle {
      background: var(--card);
      padding: 25px 50px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      width: fit-content;
      margin: 0 auto 30px auto;
      border-top: 5px solid var(--primary);
    }

    .big-num { font-size: 3.5em; font-weight: 800; color: var(--primary); line-height: 1.1; }
    .stat-formula { font-size: 1.1em; color: #7f8c8d; margin-top: 10px; }

    /* Grid Layout */
    .dashboard-grid { 
      display: grid; 
      grid-template-columns: 1.4fr 1fr; 
      gap: 25px; 
      max-width: 1100px; 
      margin: 0 auto; 
    }

    .card { 
      background: var(--card); 
      border-radius: 15px; 
      padding: 25px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* Table */
    .table-container { max-height: 450px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; color: #95a5a6; border-bottom: 2px solid #eee; font-size: 0.85em; text-transform: uppercase; }
    td { padding: 12px; border-bottom: 1px solid #f8f9fa; }
    
    .badge { padding: 4px 10px; border-radius: 6px; color: white; font-size: 0.75em; font-weight: 700; }

    #loading { text-align: center; font-size: 1.2em; color: #bdc3c7; margin-top: 50px; }

    @media (max-width: 800px) { .dashboard-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<h1>üëΩ Pat the Alien: Class Results</h1>
<div class="subtitle">Live analysis from the Veil of Ignorance</div>

<div class="stat-circle">
  <div class="big-num" id="avgSigma">--</div>
  <div class="stat-formula" id="mathLabel">
    $$\bar{\sigma} = \frac{1}{n} \sum_{i=1}^{n} \sigma_i$$
  </div>
</div>

<div class="control-panel">
  <button class="btn btn-download" onclick="downloadCSV()">üì• Download CSV</button>
  <button class="btn btn-clear" onclick="clearData()">‚ö†Ô∏è Clear Data</button>
</div>

<div id="loading">Connecting to spreadsheet...</div>

<div class="dashboard-grid" id="dashboardContent" style="display:none;">
  
  <div class="card">
    <h3 style="margin-top:0;">Distribution of Risk Aversion</h3>
    <canvas id="riskChart"></canvas>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Student Leaderboard</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Value</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbzUunIN9LaSl-Wl9yFCtkMbhkYG6XG65u3XU0QAeQKjclin3JkK6ltlcOZXpMNiavVb/exec"; 

let currentData = [];
let myChart = null;

async function loadData() {
  try {
    const response = await fetch(DATA_URL);
    const data = await response.json();
    currentData = data;
    
    document.getElementById("loading").style.display = "none";
    document.getElementById("dashboardContent").style.display = "grid";

    updateUI(data);
    
    if (window.MathJax) MathJax.typesetPromise();
  } catch (e) { console.error(e); }
}

function updateUI(data) {
  if(!data || data.length === 0) return;

  const n = data.length;
  const avg = data.reduce((sum, s) => sum + s.sigma, 0) / n;
  document.getElementById("avgSigma").innerText = avg.toFixed(2);

  // Dynamic formula update
  document.getElementById("mathLabel").innerHTML = `$$\\bar{\\sigma} = \\frac{1}{${n}} \\sum_{i=1}^{${n}} \\sigma_i$$`;

  data.sort((a, b) => b.sigma - a.sigma);
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.forEach(s => {
    let color = "#f1c40f"; 
    let type = "Balanced";
    if (s.sigma > 3) { color = "#e74c3c"; type = "Cautious"; }
    else if (s.sigma < 1) { color = "#2ecc71"; type = "Risk Taker"; }

    tbody.innerHTML += `
      <tr>
        <td style="font-weight:600;">${s.name}</td>
        <td>\\(\\sigma = ${s.sigma.toFixed(2)}\\)</td>
        <td><span class="badge" style="background:${color}">${type}</span></td>
      </tr>`;
  });

  const counts = [0, 0, 0, 0, 0];
  data.forEach(s => {
    if (s.sigma < 1) counts[0]++;
    else if (s.sigma < 2) counts[1]++;
    else if (s.sigma < 3) counts[2]++;
    else if (s.sigma < 4) counts[3]++;
    else counts[4]++;
  });

  renderChart(counts);
}

function renderChart(counts) {
  const ctx = document.getElementById('riskChart').getContext('2d');
  if(myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ["<1", "1-2", "2-3", "3-4", ">4"],
      datasets: [{
        data: counts,
        backgroundColor: ['#2ecc71', '#3498db', '#f1c40f', '#e67e22', '#e74c3c'],
        borderRadius: 5
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
    }
  });
}

function downloadCSV() {
  if (currentData.length === 0) return;
  let csv = "Name,Sigma\n" + currentData.map(s => `${s.name},${s.sigma}`).join("\n");
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'pat_results.csv';
  a.click();
}

async function clearData() {
  if (!confirm("Clear all data?")) return;
  fetch(DATA_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "clear" }) });
  alert("Wiping data...");
  setTimeout(loadData, 2000);
}

loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
