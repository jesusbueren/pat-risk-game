<!DOCTYPE html>
<html>
<head>
  <title>Pat the Alien – Risk Game</title>
</head>
<body>

<h2>Pat the Alien – Choose Your Country for the Year!</h2>

<div id="game"></div>

<script>
const backendURL = "YOUR_WEB_APP_URL_HERE";  // Replace with your Apps Script URL
const id = Math.random().toString(36).substring(2, 10);
let studentName = "";

let sigmaLow = 0;
let sigmaHigh = 20;
let sigmaEstimate = null;
let questionNumber = 0;

// Questions array for bisection (first question hardcoded)
const questions = [
  {safe: [40000, 40000], risky: [60000, 20000], p: 0.5}, 
  {safe: null, risky: null, p: 0.5}, 
  {safe: null, risky: null, p: 0.5}, 
  {safe: null, risky: null, p: 0.5}, 
  {safe: null, risky: null, p: 0.5} 
];

function askName() {
  document.getElementById("game").innerHTML = `
    <p>Welcome! Pat the Alien must choose a country to live in for the next year.</p>
    <p>Some countries are safer, some are risky. Your choices will reveal how much you dislike uncertainty!</p>
    <p>Enter your name or initials to start:</p>
    <input type="text" id="nameInput"/>
    <br><br>
    <button onclick="saveName()">Start</button>
  `;
}

function saveName() {
  const input = document.getElementById("nameInput").value.trim();
  if(input === "") { alert("Please enter a name"); return; }
  studentName = input;
  nextQuestion();
}

function nextQuestion() {
  questionNumber++;
  if(questionNumber > questions.length || sigmaEstimate !== null) {
    recordSigma();
    document.getElementById("game").innerHTML = `
      <h3>Thanks for playing, ${studentName}!</h3>
      <p>Your estimated risk aversion σ = ${sigmaEstimate.toFixed(2)}</p>
      <p>Check the spreadsheet to see the class distribution later!</p>
    `;
    return;
  }

  const q = questions[questionNumber-1];

  if(questionNumber === 1){
    // First fun choice: identify risk-neutral vs risk-averse
    document.getElementById("game").innerHTML = `
      <p><b>Question 1:</b> Choose the country you prefer to live in for the year:</p>
      <p>Country A: Safe → earn €40,000 for sure</p>
      <p>Country B: Risky → 50% chance earn €60,000, 50% chance earn €20,000</p>
      <button onclick="choose('A')">Country A (Safe)</button>
      <button onclick="choose('B')">Country B (Risky)</button>
    `;
  } else {
    // Bisection for later questions
    const mid = (sigmaLow + sigmaHigh)/2;
    q.safe = [40000 + mid*500, 40000 - mid*500];  // scaling to make numbers reasonable
    q.risky = [40000 + mid*1000, 40000 - mid*1000];

    document.getElementById("game").innerHTML = `
      <p><b>Question ${questionNumber}:</b> Choose the country you prefer to live in for the year:</p>
      <p>Country A: 50% chance €${q.safe[0].toLocaleString()}, 50% chance €${q.safe[1].toLocaleString()} (Safer)</p>
      <p>Country B: 50% chance €${q.risky[0].toLocaleString()}, 50% chance €${q.risky[1].toLocaleString()} (Riskier)</p>
      <button onclick="choose('A')">Country A</button>
      <button onclick="choose('B')">Country B</button>
    `;
  }
}

function choose(option) {
  if(questionNumber === 1){
    if(option === 'B'){
      sigmaEstimate = 0; // Not risk averse
    } else {
      sigmaLow = 0; sigmaHigh = 20; // Continue bisection
    }
  } else {
    const mid = (sigmaLow + sigmaHigh)/2;
    if(option === 'A') sigmaLow = mid;  // prefers safe → more risk averse
    else sigmaHigh = mid;  // prefers risky → less risk averse

    if(questionNumber === questions.length) sigmaEstimate = (sigmaLow + sigmaHigh)/2;
  }

  nextQuestion();
}

function recordSigma() {
  fetch(backendURL, {
    method: "POST",
    body: JSON.stringify({
      name: studentName,
      id: id,
      sigma: sigmaEstimate
    })
  });
}

// Start
askName();
</script>

</body>
</html>
